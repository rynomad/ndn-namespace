<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: database.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: database.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 *
 *@external ContentStore
 *@see http://rynomad.github.io/ndn-javascript-data-structures/doc/ContentStore.html
 *
 */

var leveldown = require("leveldown"),
    levelup = require("levelup"),
    path = (process.env.HOME || process.env.USERPROFILE || process.env.HOMEPATH || "") + "/.NDN-Repo",
    ndn;
var debug = true;

/**NDN Database
 *@constructor
 *@param {ContentStore} index - the in-memory {@link http://rynomad.github.io/ndn-javascript-data-structures/doc/ContentStore.html|ContentStore} to do lookups on the underlying key-value store
 *@param {Object} - policy an parameter option for deciding on policies for accepting/rejecting storage requests
 *@returns {Database}
 */
function Database (index, policy, onopen){
  var self = this;
  this.index = index;
  this.nameTree = index.nameTree;
  this.ndn = index.ndn;
  this.db = levelup(policy.path || path, {db: leveldown,
                                          valueEncoding: "json"
                                         }, function(){
    self.populateNameTree(onopen);
  });
  return this;
}

/** Install the NDN-lib Object
 *@param {Object} NDN NDN-lib as object
 */
Database.installNDN = function(NDN){
  ndn = NDN;
  return this;
};

/**get an element from a {RepoEntry}
 *@param {RepoEntry} repoEntry the entry for the desired element
 *@param {function} callback function receiving (err, element) as arguments, asyncronously
 *@returns {this} for chaining
 */
Database.prototype.getElement = function(repoEntry, callback){
  this.db.get(repoEntry.uri, function(err, data){
   if (!Buffer.isBuffer(data)){
     data = new Buffer(data);
   }
   callback(err, data);
  });
  return this;
};

/**Insert an element into the DB and a corresponding RepoEntry into the index
 *@param {Buffer} element - raw data packet
 *@param {Object} data - the NDN.Data object of the packet
 *@param {function=} callback - called with no arguments on success, with err if fail
 *@returns {this} for chaining
 */
Database.prototype.insert = function(element, data, callback){
  var db = this.db,
      self = this;
  callback = callback || function(){};

  db.put(data.name.toUri(), element, function(err){
    self.index.insert(element,data);
    callback(err);
  });

  return this;
};

/**Populate the index with keys from the db, called once on startup
 *@private
 *@param {function} callback called with err if one occurs
 */
Database.prototype.populateNameTree = function(callback){
  var self = this
    , db = self.db;
  callback = callback || function(){return;};

  db.createKeyStream()
    .on("data",function(key){
      self.index.insert(null, new ndn.Data(new ndn.Name(key)));
    })
    .on("error", function(err){
      callback(err);
    })
    .on("close", function(){
      self.spun = true;
      callback();
    });
};

/**Check the database for data matching an interest
 *@param {Object} interest and NDN.Interest object
 *@param {function} callback recieves (err, element) err is null if everything is OK, element is a Buffer with the raw data packet
 *@returns {this} for chaining
 */
Database.prototype.check = function(interest, callback, db) {
  db = db || this;
  if (!db.spun){
    setTimeout(db.check, 200, interest, callback, db);
  } else {
    db.index.check(interest, callback);
  }
  return this;
};

module.exports = Database;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Externals</h3><ul><li><a href="external-ContentStore.html">ContentStore</a></li></ul><h3>Classes</h3><ul><li><a href="Database.html">Database</a></li><li><a href="InterestHandler.html">InterestHandler</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Wed Jul 30 2014 16:00:47 GMT-0600 (MDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
